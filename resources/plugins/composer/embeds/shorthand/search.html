<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Shorthand Embed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
      max-width: 600px;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    .color-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    input[type="text"], input[type="url"] {
      width: 100%;
      padding: 0.4rem;
      font-size: 1rem;
    }
    input[type="button"] {
      padding: 0.6rem 1rem;
      margin-top: 1.5rem;
    }
  </style>

  <script>
    const parseQueryString = () => {
      const params = new URLSearchParams(window.location.search);
      const k = params.get("k") || "";
      let p = {};
      try {
        const raw = decodeURIComponent(params.get("p") || "{}");
        p = JSON.parse(raw);
      } catch (e) {
        console.warn("‚ö†Ô∏è Failed to parse param `p`: ", e);
      }
      return { k, p };
    };

    const sendMessage = (action, data) => {
      setTimeout(() => {
        window.parent.postMessage(
          JSON.stringify({
            source: "custom_embed",
            action,
            data,
            key: parseQueryString().k
          }),
          "*"
        );
      }, 0);
    };

    function syncColorInputs(colorInput, hexInput) {
      colorInput.addEventListener("input", () => {
        hexInput.value = colorInput.value;
      });
      hexInput.addEventListener("input", () => {
        if (/^#([0-9A-F]{3}){1,2}$/i.test(hexInput.value)) {
          colorInput.value = hexInput.value;
        }
      });
    }

    window.submitEmbed = function submitEmbed() {
      const url = document.getElementById("storyUrl").value;
      const slug = url.split("/").filter(Boolean).pop();

      const payload = {
        type: "custom_embed",
        embed: {
          id: `shorthand-${slug}`,
          url: url,
          config: {
            button_text: document.getElementById("btnText").value,
            background_color: document.getElementById("bgColorHex").value,
            text_color: document.getElementById("textColorHex").value
          }
        }
      };

      console.log("üëÄ Full message sent to Composer:", JSON.stringify({
        source: "custom_embed",
        action: "insert",
        data: payload,
        key: parseQueryString().k
      }));

      sendMessage("insert", payload);
      alert("‚úÖ Le lien a √©t√© ajout√© √† l'article.");
      window.setTimeout(() => window.close(), 300);
    }

    window.cancelEmbed = function cancelEmbed() {
      sendMessage("cancel");
    };
  </script>
</head>
<body>

<h2>Ins√©rer un lien vers une histoire Shorthand</h2>

<label for="storyUrl">URL de l'histoire Shorthand</label>
<input type="url" id="storyUrl" placeholder="https://..." />

<label for="btnText">Texte du bouton</label>
<input type="text" id="btnText" value="D√©couvrir le contenu" />

<label>Couleur du bouton</label>
<div class="color-row">
  <input type="color" id="bgColor" value="#D51D2C" />
  <input type="text" id="bgColorHex" value="#D51D2C" />
</div>

<label>Couleur du texte</label>
<div class="color-row">
  <input type="color" id="textColor" value="#FFFFFF" />
  <input type="text" id="textColorHex" value="#FFFFFF" />
</div>

<input type="button" id="submitBtn" value="Ins√©rer" onclick="submitEmbed()" />
<input type="button" value="Annuler" onclick="cancelEmbed()" />

<script>
  syncColorInputs(document.getElementById("bgColor"), document.getElementById("bgColorHex"));
  syncColorInputs(document.getElementById("textColor"), document.getElementById("textColorHex"));
</script>

</body>
</html>
